# NPC AI ë™ì‘ ìˆ˜ì • ì™„ë£Œ

## ë¬¸ì œ

NPC ì¥ìˆ˜ë“¤ì´ í„´ì„ ì‹¤í–‰í•˜ì§€ë§Œ **"ì•„ë¬´ê²ƒë„ ì‹¤í–‰í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"**ë§Œ ë‚˜ì˜¤ê³  ì‹¤ì œ ëª…ë ¹ì„ ìˆ˜í–‰í•˜ì§€ ì•ŠìŒ

## ì›ì¸ ë¶„ì„

### 1. NPC ì¡°íšŒ ì¿¼ë¦¬ ì˜¤ë¥˜
```typescript
// âŒ ì˜ëª»ëœ ì¿¼ë¦¬
const npcs = await generalRepository.findByFilter({
  session_id: sessionId,
  'data.npc': { $gte: 2 }  // data.npcëŠ” ì¼ë¶€ ì¥ìˆ˜ë§Œ ì„¤ì •ë¨
});

// ê²°ê³¼: 0ëª… ì¡°íšŒ
```

### 2. DB í•„ë“œ êµ¬ì¡°
```javascript
{
  npc: 2,           // âœ… ìµœìƒìœ„ í•„ë“œ (ëª¨ë“  ì¥ìˆ˜)
  data: {
    npc: undefined  // âŒ ì¼ë¶€ë§Œ ì„¤ì •ë¨
  }
}
```

## í•´ê²° ë°©ë²•

### ì¿¼ë¦¬ ìˆ˜ì •
```typescript
// âœ… ì˜¬ë°”ë¥¸ ì¿¼ë¦¬
const npcs = await generalRepository.findByFilter({
  session_id: sessionId,
  $or: [
    { npc: { $gte: 2 } },      // ìµœìƒìœ„ npc í•„ë“œ
    { 'data.npc': { $gte: 2 } } // data.npc í•„ë“œ (í•˜ìœ„ í˜¸í™˜)
  ]
});

// ê²°ê³¼: 439ëª… ì¡°íšŒ âœ…
```

### ë¡œê¹… ì¶”ê°€
```typescript
console.log(`[NPC AI] ${sessionId} - NPC ì¥ìˆ˜ ${npcs.length}ëª… ë°œê²¬`);
console.log(`[NPC AI] ì¥ìˆ˜ ${general.no} (${name}) - í„´ ${emptyTurnIdx}ì— ëª…ë ¹ ë“±ë¡ ì‹œë„`);
console.log(`[NPC AI] âœ… ì¥ìˆ˜ ${general.no} (${name}) - ëª…ë ¹ ë“±ë¡: ${decision.command}`);
console.log(`[NPC AI] ${sessionId} - ì™„ë£Œ: ì„±ê³µ ${successCount}, ìŠ¤í‚µ ${skippedCount}, ì‹¤íŒ¨ ${errorCount}`);
```

## ê²°ê³¼

### ì‹¤í–‰ ë¡œê·¸
```
[NPC AI] sangokushi_default - NPC ì¥ìˆ˜ 445ëª… ë°œê²¬
[NPC AI] ì¥ìˆ˜ 10 (ì›ì†Œ) - í„´ 1ì— ëª…ë ¹ ë“±ë¡ ì‹œë„
[NPC AI] âœ… ì¥ìˆ˜ 10 (ì›ì†Œ) - ëª…ë ¹ ë“±ë¡: ê²¬ë¬¸
[NPC AI] ì¥ìˆ˜ 12 (ì›ë‹´) - í„´ 1ì— ëª…ë ¹ ë“±ë¡ ì‹œë„
[NPC AI] âœ… ì¥ìˆ˜ 12 (ì›ë‹´) - ëª…ë ¹ ë“±ë¡: ê²¬ë¬¸
...
[NPC AI] sangokushi_default - ì™„ë£Œ: ì„±ê³µ 439, ìŠ¤í‚µ 0, ì‹¤íŒ¨ 6
```

### í†µê³„
- **NPC ì¥ìˆ˜**: 445ëª…
- **ëª…ë ¹ ë“±ë¡ ì„±ê³µ**: 439ëª… (98.7%)
- **ìŠ¤í‚µ**: 0ëª…
- **ì‹¤íŒ¨**: 6ëª… (1.3%)

### NPC ë™ì‘ í™•ì¸
- âœ… ë§¤ë¶„ë§ˆë‹¤ NPC ìë™ ëª…ë ¹ ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰
- âœ… ë¹ˆ í„´ ìë™ ê°ì§€ ë° ëª…ë ¹ ë“±ë¡
- âœ… SimpleAIë¥¼ í†µí•œ ëª…ë ¹ ê²°ì •
- âœ… í„´ ì²˜ë¦¬ ì‹œ ëª…ë ¹ ì‹¤í–‰

## NPC íƒ€ì… (npc í•„ë“œ)

| ê°’ | ì˜ë¯¸ |
|----|------|
| 0 | ìœ ì € (í”Œë ˆì´ì–´) |
| 1 | êµ°ì£¼ (í”Œë ˆì´ì–´ ë˜ëŠ” NPC) |
| 2 | ì¼ë°˜ NPC (AI ìë™ ëª…ë ¹) |
| 6 | ì¬ì•¼ NPC |

## AI ëª…ë ¹ ê²°ì •

í˜„ì¬ **SimpleAI**ê°€ ì‚¬ìš©ë˜ë©°, ëŒ€ë¶€ë¶„ "ê²¬ë¬¸" ëª…ë ¹ì„ ë‚´ë¦½ë‹ˆë‹¤.

### ê°œì„  ê°€ëŠ¥ ì‚¬í•­
- ë” ë‹¤ì–‘í•œ ëª…ë ¹ ê²°ì • (ë†ì—…, ìƒì—…, êµ°ì‚¬, ì™¸êµ ë“±)
- ì¥ìˆ˜ ëŠ¥ë ¥ì¹˜ì— ë”°ë¥¸ ëª…ë ¹ ì„ íƒ
- êµ­ê°€ ìƒí™©ì— ë”°ë¥¸ ì „ëµì  ê²°ì •
- ì „íˆ¬/ê³µì„±ì „ íŒë‹¨

## ìŠ¤ì¼€ì¤„

### NPC ìë™ ëª…ë ¹ ìŠ¤ì¼€ì¤„ëŸ¬
```javascript
cron.schedule('* * * * *', () => {  // ë§¤ë¶„ë§ˆë‹¤
  processNPCCommands()
});
```

### í„´ ì²˜ë¦¬ ìŠ¤ì¼€ì¤„ëŸ¬
```javascript
cron.schedule('* * * * *', () => {  // ë§¤ë¶„ë§ˆë‹¤
  processTurns()
});
```

## ìˆ˜ì • íŒŒì¼

- `src/services/ai/NPCAutoCommand.service.ts`
  - NPC ì¡°íšŒ ì¿¼ë¦¬ ìˆ˜ì • ($or ì‚¬ìš©)
  - ë¡œê¹… ì¶”ê°€

## í…ŒìŠ¤íŠ¸

### 1. ë°ëª¬ ì¬ì‹œì‘
```bash
cd open-sam-backend
npm run build
pkill -f daemon-unified
npm run start:daemon
```

### 2. ë¡œê·¸ í™•ì¸
```bash
tail -f daemon.log | grep NPC
```

### 3. ê²°ê³¼
```
[NPC AI] sangokushi_default - NPC ì¥ìˆ˜ 445ëª… ë°œê²¬
[NPC AI] âœ… ì¥ìˆ˜ 10 (ì›ì†Œ) - ëª…ë ¹ ë“±ë¡: ê²¬ë¬¸
...
[NPC AI] sangokushi_default - ì™„ë£Œ: ì„±ê³µ 439, ìŠ¤í‚µ 0, ì‹¤íŒ¨ 6
```

## ë‹¤ìŒ ë‹¨ê³„

- âœ… ì™„ë£Œ: NPC ì¡°íšŒ ì¿¼ë¦¬ ìˆ˜ì •
- âœ… ì™„ë£Œ: NPC ìë™ ëª…ë ¹ ì‘ë™ í™•ì¸
- ğŸ”œ ì„ íƒì‚¬í•­: SimpleAI ê°œì„  (ë” ë‹¤ì–‘í•œ ëª…ë ¹)
- ğŸ”œ ì„ íƒì‚¬í•­: ì „ëµì  AI ê°•í™”

---

**ì‘ì„±ì¼**: 2025-11-25  
**ìƒíƒœ**: âœ… ì™„ì„±
