# 턴 프로세서 데몬

게임 턴을 자동으로 처리하는 백그라운드 데몬입니다.

## 기능

- 주기적으로 모든 활성 세션의 턴을 처리
- Socket.IO를 통한 실시간 턴 완료 알림
- Redis 기반 분산 락으로 중복 실행 방지

## 설정

### 환경 변수

- `ENABLE_TURN_PROCESSOR`: 턴 프로세서 활성화 여부 (기본값: `true`)
- `TURN_PROCESSOR_CRON`: Cron 표현식 (기본값: `* * * * *` - 매분)
- `TURN_PROCESSOR_RUN_IMMEDIATELY`: 시작 시 즉시 실행 여부 (기본값: `false`)

### Cron 표현식 예시

- `* * * * *` - 매분
- `*/5 * * * *` - 5분마다
- `0 * * * *` - 매시간
- `0 */2 * * *` - 2시간마다

## 실행 방법

### 서버 내장 모드 (권장)

서버가 시작될 때 자동으로 시작됩니다:

```bash
npm run dev
```

### 독립 실행 모드

별도 프로세스로 실행할 수 있습니다:

```bash
npm run dev:turn
# 또는
npm run start:turn
```

## 동작 방식

1. Cron 스케줄에 따라 `processTurns()` 함수가 실행됩니다
2. 모든 활성 세션을 조회합니다 (통합 상태가 아닌 세션)
3. 각 세션에 대해 `ExecuteEngineService.execute()`를 호출합니다
4. 턴이 처리되면 Socket.IO를 통해 클라이언트에 브로드캐스트합니다

## 로그

턴 프로세서는 다음 이벤트를 로깅합니다:

- 세션별 턴 처리 완료
- 락 획득 실패 (다른 인스턴스가 처리 중)
- 오류 발생

## 주의사항

- 여러 인스턴스가 동시에 실행되면 Redis 락으로 중복 실행을 방지합니다
- 세션이 `paused` 상태이거나 통합 상태(`isunited`가 2 또는 3)인 경우 처리하지 않습니다

