# Session 4: Dex (Proficiency) System - Implementation Plan

## Tasks Overview

### 1. Create src/utils/dex-calculator.ts
- getDexFieldName(armType): string
- calculateDexExp(baseExp, armType, train, atmos, affectTrainAtmos): number
- getDexLevel(dexValue): number
- getDexBonus(dexValue): { attack: number, defense: number }
- getDexLevelList(): Array<{ threshold: number, color: string, name: string }>

### 2. Update src/models/general.model.ts
- Already has addDex() method implemented
- Verify dex field structure matches PHP

### 3. Update Commands (10+)
- conscript.ts ✓ (already has addDex)
- train.ts ✓ (already has addDex)
- trainTroops.ts ✓ (already has addDex)
- recruitTroops.ts
- drill.ts
- reinforceDefense.ts
- Any other troop-related commands

### 4. Create Tests
- src/utils/__tests__/dex-calculator.test.ts

## PHP Reference Analysis

### getDexLevelList() - func_converter.php
```php
[0, 'navy', 'F-'],
[350, 'navy', 'F'],
[1375, 'navy', 'F+'],
[3500, 'skyblue', 'E-'],
[7125, 'skyblue', 'E'],
[12650, 'skyblue', 'E+'],
[20475, 'seagreen', 'D-'],
[31000, 'seagreen', 'D'],
[44625, 'seagreen', 'D+'],
[61750, 'teal', 'C-'],
[82775, 'teal', 'C'],
[108100, 'teal', 'C+'],
[138125, 'limegreen', 'B-'],
[173250, 'limegreen', 'B'],
[213875, 'limegreen', 'B+'],
[260400, 'darkorange', 'A-'],
[313225, 'darkorange', 'A'],
[372750, 'darkorange', 'A+'],
[439375, 'tomato', 'S-'],
[513300, 'tomato', 'S'],
[594625, 'tomato', 'S+'],
```

### General::addDex() - General.php:420
```php
if ($armType == GameUnitConst::T_CASTLE) {
    $armType = GameUnitConst::T_SIEGE;
}

if ($armType < 0) {
    return;
}

if ($armType == GameUnitConst::T_WIZARD) {
    $exp *= 0.9;
} else if ($armType == GameUnitConst::T_SIEGE) {
    $exp *= 0.9;
}

if ($affectTrainAtmos) {
    $exp *= ($this->getVar('train') + $this->getVar('atmos')) / 200;
}

$dexType = "dex{$armType}";
$exp = $this->onCalcStat($this, 'addDex', $exp, ['armType' => $armType]);
$this->increaseVar($dexType, $exp);
```

### Constants
- GameConst::$dexLimit = 1000000

### Field Names
- dex1 = Infantry (보병)
- dex2 = Archer (궁병)
- dex3 = Cavalry (기병)
- dex4 = Wizard (귀병)
- dex5 = Siege (차병)
