# 에이전트 작업 지시서 (Samgukji Backend)

문서 메모에 따라 `ProcessWar.ts` 리팩토링이 최우선입니다. 이후 전투 리플레이, 명예의 전당/랭킹, 테스트 순으로 진행하세요.

---

## 1) 전투 로직 리팩토링 (Critical)
### 목표
비대해진 `ProcessWar.ts`를 역할별 서비스로 분리하여 유지보수성과 테스트 용이성 확보.

### 체크리스트
- [ ] `ProcessWar.ts` 의존성 및 데이터 흐름 분석 (간단 다이어그램/노트)
- [ ] `BattleTurnService`: 턴 순서·상태 관리 로직 이관
- [ ] `BattleCalculationService`: 데미지/확률/보정 로직 이관
- [ ] `BattleSkillService`: 장수 스킬·병종 특수기·책략 로직 이관
- [ ] `ProcessWar.ts`를 오케스트레이션만 담당하도록 경량화 (서비스 주입)
- [ ] 기존 테스트/시뮬레이션 통과 확인 (기능 변경 없음)

### 시작 프롬프트
```
현재 `open-sam-backend/src/services/ProcessWar.ts` 파일이 비대합니다.
다음 세 서비스로 분리하기 위한 설계 계획(Pseudocode 포함)을 세워 주세요:
1) BattleTurnService (턴 관리)
2) BattleCalculationService (전투 수치 계산)
3) BattleSkillService (스킬 및 계략)
로직 이동·의존성 주입·파일 구조를 단계별로 제안해 주세요.
```

### 이어지는 프롬프트 예시 (구현 단계)
```
설계에 따라 `BattleCalculationService`부터 분리하세요.
1) `ProcessWar.ts`의 데미지/확률 관련 순수 함수 추출
2) 새 서비스 파일 생성 후 로직 이동
3) `ProcessWar.ts`에서 새 서비스를 import해 사용하도록 수정
작업 후 기존 유닛 테스트가 있다면 실행해 정합성을 확인해 주세요.
```

---

## 2) 명예의 전당 & 랭킹 (Core Features)
### 목표
천하통일 시점의 상태를 저장하고, 장수/국가 랭킹 및 역사 기록을 조회하는 API 제공.

### 체크리스트
- [ ] DB 스키마 설계: `History`(통일 기록), `HallOfFame`(랭킹 스냅샷)
- [ ] 통일 이벤트 트리거 시 상태 요약 저장 로직 (`HistoryService`)
- [ ] API:
  - [ ] `GET /api/history`: 역대 통일 기록 (페이지네이션)
  - [ ] `GET /api/ranking/generals`: 장수 랭킹 (능력치/공적/전적)
  - [ ] `GET /api/ranking/nations`: 국가 랭킹 (국력/인구/병력)
- [ ] 프론트 연동 위한 스펙 명세(Swagger/TS Interface) 갱신

### 시작 프롬프트
```
명예의 전당 시스템을 위해 MongoDB 스키마를 설계해 주세요.
저장 필드: 통일 연도, 통일 국가, 군주명, 주요 장수 목록·스탯, 최종 국력 데이터.
스키마 설계 후 천하통일 이벤트 발생 시 데이터를 저장하는 `HistoryService` 뼈대를 만들어 주세요.
```

### 이어지는 프롬프트 예시 (API 구현)
```
설계된 스키마로 조회 API를 구현해 주세요:
1) `/api/ranking/generals`: 장수 능력치/공적 기준 내림차순
2) `/api/history`: 역대 통일 기록 조회 (페이지네이션)
Express 라우터/컨트롤러 작성과 인덱싱 전략 제안 포함해 주세요.
```

---

## 3) 전투 리플레이 시스템
### 목표
턴제 전투 로그를 구조화하여 저장하고, 재생 가능한 JSON 포맷 제공.

### 체크리스트
- [ ] 리플레이 데이터 구조 정의: 턴별 행동(누가/대상/행동/결과) 기록
- [ ] 전투 로거 구현: `ProcessWar`(또는 분리된 서비스)에서 리플레이 포맷으로 이벤트 수집
- [ ] 저장소 설계: 전투 종료 시 `BattleLog` 컬렉션 등에 저장(필요 시 압축)
- [ ] 재생 API: 전투 ID로 리플레이 JSON 반환

### 시작 프롬프트
```
턴제 전투를 재현할 리플레이 JSON 구조(Interface)를 정의해 주세요.
각 턴의 행동(공격/이동/스킬)과 결과(데미지, 사기 변화)를 복원 가능하도록,
데이터 크기를 최소화한 구조를 제안해 주세요.
```

### 이어지는 프롬프트 예시 (로깅 구현)
```
정의한 리플레이 구조에 맞춰 `ProcessWar`(또는 분리 서비스)에 로그 수집을 추가해 주세요.
`ReplayBuilder`가 턴 데이터를 모으고, 전투 종료 시 DB에 저장하는 흐름을 구현해 주세요.
```

---

## 4) 테스트 & 안정화
### 목표
핵심 시나리오와 엣지 케이스에 대한 자동화 테스트 확보.

### 체크리스트
- [ ] 전쟁 사이클 E2E: 선전포고 → 출병 → 전투 → 점령/멸망
- [ ] 내정 사이클 단위 테스트: 자원 수입·턴 증가 검증
- [ ] 엣지 케이스: 장수 0명, 군량 부족, 이동 불가 지형 등

### 시작 프롬프트
```
전쟁 사이클을 검증하는 E2E 테스트를 작성해 주세요.
시나리오: A국이 B국에 선전포고 → A국 부대 출병 → 턴 진행 후 전투 발생 →
전투 종료 시 영토 소유권 변경 확인. Playwright 또는 Jest 기반으로 구현해 주세요.
```

---

## 권장 작업 순서
1) 전투 로직 리팩토링 (`ProcessWar.ts` 분리)
2) 전투 리플레이 시스템
3) 명예의 전당 & 랭킹
4) 테스트 보강






