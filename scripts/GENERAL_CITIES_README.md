# 장수 근거지 시스템 사용 가이드

## 개요

삼국지14 데이터를 기반으로 각 시나리오의 장수들에게 근거지(소재 도시)를 배정하는 시스템입니다.

## 파일 구조

```
scripts/
├── rtk14-general-cities.csv      # 삼국지14 장수 소재지 데이터 (1000명)
├── apply-rtk14-cities.ts         # 모든 시나리오에 자동 적용
├── update-scenario-cities.ts     # 특정 시나리오 수동 수정
└── test-general-cities.ts        # 테스트 스크립트
```

## 근거지 결정 우선순위

장수가 배치되는 도시는 다음 우선순위로 결정됩니다:

1. **`generalCities`** (시나리오 JSON) - 시나리오별 오버라이드
2. **장수 배열 인덱스 4** - 장수 데이터의 city 필드
3. **국가 수도** - fallback (기본값)

## 사용 방법

### 1. 모든 시나리오에 자동 적용

삼국지14 데이터를 기반으로 모든 시나리오에 장수 근거지를 자동 배정합니다.

```bash
npx ts-node scripts/apply-rtk14-cities.ts
```

**결과:**
- 각 시나리오 JSON에 `generalCities` 객체 추가
- 130~200명의 장수에게 근거지 배정

### 2. 특정 시나리오 수동 수정

특정 시나리오의 장수 위치를 개별 또는 일괄 수정합니다.

#### 2-1. 개별 수정

`scripts/update-scenario-cities.ts` 파일을 열고 설정을 수정합니다:

```typescript
// 수정할 시나리오
const SCENARIO_ID = 'scenario_1070';

// 장수별 근거지 수정
const CITY_UPDATES: Record<string, string | number> = {
  // 도시명으로 지정
  '유비': '신야',
  '관우': '신야',
  '장비': '신야',
  
  // 도시ID로 지정
  '조조': 2,  // 허창
  
  // 근거지 제거 (국가 수도로 fallback)
  '장각': null,
};
```

#### 2-2. 일괄 수정

특정 조건의 모든 장수를 일괄 변경합니다:

```typescript
const BULK_UPDATES: BulkUpdate[] = [
  // 예시 1: 조나라(1) 장수들을 모두 허창으로
  {
    filter: { nation: 1 },
    newCity: '허창'
  },
  
  // 예시 2: 영안에 있는 장수들을 모두 신야로
  {
    filter: { currentCity: '영안' },
    newCity: '신야'
  },
  
  // 예시 3: 오나라(3)와 촉나라(4) 장수들을 건업으로
  {
    filter: { nation: [3, 4] },
    newCity: '건업'
  },
];
```

실행:

```bash
npx ts-node scripts/update-scenario-cities.ts
```

### 3. 시나리오 JSON 직접 편집

간단한 수정은 시나리오 JSON 파일을 직접 편집할 수도 있습니다:

```json
{
  "title": "【역사모드7】 적벽대전",
  "generalCities": {
    "유비": "신야",
    "관우": "신야",
    "제갈량": "신야",
    "조조": "허창",
    "손권": "시상"
  }
}
```

## 도시명 목록

### 주요 도시 (이름으로 지정 가능)

| 도시명 | ID | 지역 |
|--------|-----|------|
| 허창 | 2 | 중원 |
| 낙양 | 3 | 중원 |
| 장안 | 4 | 서북 |
| 성도 | 5 | 익주 |
| 양양 | 6 | 형주 |
| 건업 | 7 | 강동 |
| 업 | 1 | 하북 |
| 시상 | 15 | 강동 |
| 영안 | 45 | 익주 |
| 한중 | 24 | 익주 |
| 신야 | - | 형주 |

전체 도시 목록: `config/scenarios/sangokushi/data/cities.json` 참조

## 도시명 매핑

삼국지14 도시명이 우리 게임과 다른 경우 자동 변환됩니다:

| 삼국지14 | 우리 게임 |
|----------|-----------|
| 면죽관 | 면죽 |
| 소패 | 패 |
| 호뢰관 | 호로 |
| 무위 | 서량 |
| 무관 | 장안 |
| 건안 | 건업 |
| 양평관 | 양평 |

## 테스트

시스템이 제대로 작동하는지 확인:

```bash
npx ts-node scripts/test-general-cities.ts
```

**출력 예시:**
```
=== Scenario 1070 (적벽대전) ===
Total generals: 491
GeneralCities entries: 175

주요 장수 근거지:
  유비: 영안 (ID: 45)
  관우: 영안 (ID: 45)
  조조: 허창 (ID: 2)
  손권: 시상 (ID: 15)
```

## 주의사항

1. **서버 재시작 필요**: JSON 파일 수정 후 백엔드 서버를 재시작해야 반영됩니다.
2. **백업**: 수정 전 시나리오 파일을 백업하는 것을 권장합니다.
3. **국가 번호**: 시나리오마다 국가 번호가 다를 수 있으니 확인이 필요합니다.
4. **재야 장수**: nation이 0 또는 999인 장수는 근거지가 배정되지 않습니다.

## 시나리오별 적용 현황

| 시나리오 | 근거지 배정 장수 |
|----------|------------------|
| 1010 황건적의 난 | 60명 |
| 1020 반동탁연합 | 138명 |
| 1030 군웅할거 | 172명 |
| 1050 관도대전 | 169명 |
| 1070 적벽대전 | 175명 |
| 1090 삼국정립 | 162명 |
| 1110 출사표 | 158명 |
| 1120 백마장군 | 134명 |

## 문제 해결

### 장수가 잘못된 도시에 배치됨

1. `generalCities`에서 해당 장수의 도시를 수정
2. 또는 `update-scenario-cities.ts`로 일괄 수정

### 도시명이 인식되지 않음

1. `cities.json`에서 정확한 도시명 확인
2. 도시ID로 직접 지정
3. 도시명 매핑 추가 필요시 `apply-rtk14-cities.ts`의 `CITY_NAME_MAP` 수정

### 변경사항이 반영되지 않음

1. 백엔드 서버 재시작
2. 브라우저 캐시 삭제
3. JSON 파일 문법 오류 확인 (jq로 검증 가능)

```bash
jq . config/scenarios/sangokushi/scenario_1070.json > /dev/null
```
